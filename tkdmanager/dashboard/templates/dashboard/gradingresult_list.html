{% extends "base_generic.html" %}

{% block title %}
<title>TKD Manager - Grading Result List</title>
{{ search_form.media.css }}
{% endblock %}

{% block content %}
  <h1>Grading Result List</h1>
  <form method="get" action="{% url 'dash-gradingresults' %}">
    <div class="container-md" style="margin-left: 0;">
      <div class="row row-cols-6">
          {% for field in search_form %}
              <div class="col-md-1 mb-3">
                  {{ field.errors }}
                  <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}:</label>
              </div>
              <div class="col-md-3 mb-3">
                  {{ field }}
                  {% if field.help_text %}
                      <small class="text-muted" id="{{ field.auto_id }}_helptext">{{ field.help_text|safe }}</small>
                  {% endif %}
              </div>
          {% endfor %}
      </div>
      <button type="submit" class="btn btn-outline-secondary btn-outline-thicker">Search</button>
    </div>
  </form>
{{ search_form.media.js }}
<br>
  {% if gradingresult_list %}
  <script>
    $(document).ready(function() {
        $('#email-pdfs-button').click(function() {
            const form = $('#selecteditemsform');  // Replace 'your-form-id' with the actual ID of your form
            
            $.ajax({
                url: "{% url 'dash-batch-email-gr-pdf' %}",
                type: form.attr('method'),
                data: new FormData(form[0]),
                processData: false,
                contentType: false,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                },
                success: function(data) {
                    // Determine Bootstrap 5 alert style based on success status
                    const alertStyle = data.success ? 'alert-success' : 'alert-danger';

                    // Create Bootstrap 5 alert
                    const alert = $('<div class="alert alert-dismissible fade show ' + alertStyle + '" role="alert"></div>').text(data.message);
                    const closeBtn = $('<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>');
                    alert.append(closeBtn);

                    // Append the alert to the body
                    $('body').prepend(alert);

                    // Auto-dismiss after 5 seconds for success alerts
                    if (data.success) {
                        setTimeout(function() {
                            alert.alert('close');
                        }, 5000);
                    }
                },
                error: function(error) {
                    console.error('Error:', error);
                }
            });
        });
    });
</script>
  <form id="selecteditemsform" name="selecteditems">
  <table style="width: 100%;">
    <tr>
      <th>Select</th>
      <th>Link</th>
      <th>Type</th>
      <th>Date</th>
      <th>Member</th>
      <th>For Belt</th>
      <th>Assessor(s)</th>
      <th>Award</th>

    </tr>
    {% for gr in gradingresult_list %}
      <tr class="content">
        <td>
          <input type="checkbox" name="selected_items" value="{{ gr.pk }}">
        </td>
        <td><a href="{{ gr.get_absolute_url }}">Link</a></td>
        <td>{{ gr.grading.get_grading_type_display }}</td>
        <td>{{ gr.grading.grading_datetime|date:"d/m/y" }}</td>
        <td><a href="{{ gr.member.get_absolute_url }}">{{ gr.member }}</a></td>
        <td>{{ gr.get_forbelt_display }}</td>
        <td>
          <dl>
          {% for a in gr.assessor.all %}
            <dt><a href="{{ a.get_absolute_url }}">{{ a }}</a></dt>
          {% endfor %}
          </dl>
        </td>
        <td>{% if gr.award %}{{ gr.award }}{% else %}---{% endif %}</td>
      </tr>
    {% endfor %}
  </table>
  <button type="submit" class="btn btn-outline-secondary btn-outline-thicker" formaction="{% url 'dash-batch-generate-gr-pdf' %}">Generate Certificate PDF for Selected Items</button>
  <button id="email-pdfs-button" type="submit" class="btn btn-outline-secondary btn-outline-thicker" formaction="{% url 'dash-batch-email-gr-pdf' %}">Send Certificate PDFs for Selected Items to Members</button>
  </form>
  {% else %}
    <p>There are no grading results that match your filters.</p>
  {% endif %}
{% endblock %}

<!--

    <script type="text/javascript">
    function OnSubmitForm()
    {
      if(document.pressed == 'gen')
      {
       document.selecteditems.action = "{% url 'dash-batch-generate-gr-pdf' %}";
      }
      else
      if(document.pressed == 'email')
      {
        document.selecteditems.action = "{% url 'dash-batch-email-gr-pdf' %}";
      }
      return true;
    }
    </script>


<script type="text/javascript">
function OnSubmitForm()
{
  if(document.pressed == 'Insert')
  {
   document.myform.action ="insert.html";
  }
  else
  if(document.pressed == 'Update')
  {
    document.myform.action ="update.html";
  }
  return true;
}
</script>

<form name="myform" onsubmit="return onsubmitform();">

<input type="submit" name="operation" onclick="document.pressed=this.value" value="insert" />

<input type="submit" name="operation" onclick="document.pressed=this.value" value="update" />

</form>
-->